<HTML>
<HEAD>
<META http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<TITLE>CS5460/6460 Operating Systems</TITLE>
<LINK HREF="./css/main.css" TYPE="text/css" REL="stylesheet">
<META NAME="Description" CONTENT="Home page of Anton Burtsev.">
<META NAME="Keywords" CONTENT="Anton Burtsev, Burtsev, Anton, CS5460/6460">
<SCRIPT SRC="./scripts/image_switcher.js" LANGUAGE="JavaScript"></SCRIPT>
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" TOPMARGIN="0" MARGINWIDTH="0" MARGINHEIGHT="0">
	<TABLE  ID="text" ALIGN="CENTER" WIDTH="600" BORDER="0" CELLPADDING="0" CELLSPACING="0">
	<TR>
		<TD ALIGN="LEFT" BGCOLOR="#FFFFFF"><!-- top margin --> 
			<IMG SRC="./images/spacer.gif" WIDTH="100%" HEIGHT="15" ALT="" BORDER="0"/>
		</TD>
	</TR>
	<TR>
	<TD>
		<DIV ID="tech_nav">
			<A HREF="../../index.html">Home</A>
			<IMG SRC="./images/spacer.gif" WIDTH="100%" HEIGHT="30" ALT="" BORDER="0"/>
		</DIV>
	</TD>
	</TR>	
	<TR>
	<TD COLSPAN="4" ALIGN="LEFT" BGCOLOR="#FFFFFF">


		<P>


<h1>HW5: Interrupts</h1>

<p>This homework asks you to extend your "hello world" kernel with support for handling timer interupts. 
This assignments builds on top of your 
previous HW3 and HW4 submissions</b>, i.e., you will extend the code of HW3 
to implement this additional functionality for HW4. If you don't have a working HW3 submission 
talk to us. 

<p>
Technically, you can do this assignment on any
operating system that supports the Unix API and can run Qemu (CADE
machines, your laptop that runs Linux or Linux VM, and even MacOS, etc.).
<b>You don't need to set up xv6 for this assignment</b>, but <b>if you're running
on CADE you'll have to install QEMU</b>, see <a href="../xv6-setup.html">QEMU 
setup instructions</a>. Submit your programs
and the shell through Gradescope (see instructions at the bottom of this page). 

<p><b>NOTE: YOU CANNOT PUBLICLY RELEASE SOLUTIONS TO THIS HOMEWORK</b>. It's ok to show 
your work to your future employer as a private Git repo, however any public release is prohibited. 


<h2>Overview</h2>

At a high level our goal is to learn how to construct an interrupt descriptor table and the low-level 
code for managing the interrupt entry and exit. 

First, download <a href="./src/ioapic.c">./src/ioapic.c</a>, <a href="./src/lapic.c">./src/lapic.c</a>, 
<a href="./src/picirq.c">./src/picirq.c</a> files from the <a href="./src/">./src</a> folder. 
These three files contain the code for initializing three interrupt controllers. The legacy programmable 
interrupt controller (PIC), the new local advanced programmable interrupt controller (LAPIC) and 
the Intel I/O Advanced Programmable Interrupt Controller (ioapic). We skip details of the 
initialization, and instead simply do the following two steps. 

You need to map the memory region that communicates with the LAPIC controller, specifically 
addresses 0xfec00000 -- one to one. After mapping this memory region you can download 
the <a href="./src/trap.c">./src/trap.c</a> and <a href="./src/traps.h">./src/traps.h</a> and invoke 
the <code>initpics()</code> function from your <code>main</code>. This will initialize all three controllers and enable delivery of the timer interrupt. 

<h2>Configuring IDT</h2>

<p>
First, download <a href="./src/vectors.asm""> vectors.asm </a>. This file will provide definition for 
<code>alltrap, trapret, vector32 </code>.
</p>

<p>
Your job in this assignment is to enable and implement the interrupt mechnism. More specicially, 
you need to implement <code> tvinit </code>. The job of <code> tvinit </code> is to initlize IDT 
with timer interrupt, which is at the index 32 of IDT. The entry should be initlized to jump to 
offset <code>vector32</code> with DPL 0. Hint: You can use <code> SETGATE </code> macro.  
Once IDT is properly initilized, you can go ahead use <code> lidt </code> function to load the table.
Once you finish your <code> tvinit </code>, you can call it in <code>main</code>.
</p>


<p>
Next, you need to implement definition for <code> vector32 </code> in vectors.asm. 
This is the address we pass in, which interrupt service will jump to whenever a interrupt 
is received. In vector32, we will mimic xv6 implementation, we will push errcode and trapno, 
then we will jmp to <code>alltrap</code>.
</p>

<p>
The function of <code>alltrap</code> is to set up the rest of trap frame and make sure the data segment register 
(and extra segment register) has the appropriate privilege. It will then call <code> trap </code> function, which 
is supposed to handle all the interrupt. In our case, we only have the timer interrupt enabled, so you will 
call <code> printk("."); </code> every timer interrupt happens. 
</p>

Once <code> trap </code> returns, it should fall to <code> trapret </code> function, 
which should correctly manage the kernel stack and use the <code> iret </code> to return to user. 

<h2>Submit your work</h2>

<p>
Submit your solution through Gradescope CS5460/6460 Operating Systems</a>. <b>Please zip all of your files and submit them..</b>

The structure of the zip file should be the following:

<pre>
/
- trap.c
- vectors.asm
</pre>

</b>


</div>

	</TD>			
	</TR>
	<TR>
		<TD ALIGN="LEFT" BGCOLOR="#FFFFFF"><!-- top margin --> 
			<IMG SRC="./images/spacer.gif" WIDTH="100%" HEIGHT="15" ALT="" BORDER="0"/>
		</TD>
	</TR>
	<TR>
	<TD COLSPAN="4">
		<DIV ID="tech">Updated: April, 2024</DIV>
	</TD>
	</TR>
	</TABLE>
</BODY>
</HTML>


